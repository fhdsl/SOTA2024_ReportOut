---
title: "SOTA Stats"
author: "Kate Isaac"
date: "2025-10-08"
output: html_document
---

```{r, message = FALSE}
library(here)
library(tidyverse)
library(ggVennDiagram)
library(magrittr)
```

```{r, message = FALSE}
resultsTidy <- readRDS(here("data/wrangled_data/resultsTidy_personas.rds"))
source(here("resources/scripts/shared_functions.R"))
```

```{r}
poll_opening_day <- "2024-02-15"
poll_closing_day <- "2024-03-25"
nresponses <- nrow(resultsTidy)
```

```{r}
Mode <- function(x) {
  ux <- unique(x)
  ux[which.max(tabulate(match(x, ux)))]
}
```

### Response Distribution

Responses made at the beginning of the Results section describing responses received have code supporting them here.

> Responses were received on days without advertisement

---

> Days with advertisement (at least 7 unique days) aligned with or directly preceded receiving responses

---

> The two days with the highest response count (7 and 8 respones) aligned with a user listerv reminder email (2024 - March - 13).

---

> The average number of responses in a day was about 1

---

> the most common number of responses was 0 (21 different days)

---

> followed by 1 (8 different days) if restricted to non-zero responses

---

> When considering the institutional affiliation of respondents, there were no higher than 2 responses from users from the same instutitution on any one day.

---

> Both potential and returning users responded throughout the time period with no discernible pattern related to recruitment method.

---

### User background and current work

Statements made throughout the "User background and current work" Results section have code supporting them here.

#### Figure 2A - User Type

<details><summary> Making a table for this data/question on identifying user type of the respondents </summary>

```{r}
usageDF <- resultsTidy %>%
  select(c(CurrentUsageDescription, UserType)) %>%
  table() %>%
  as.data.frame() %>%
  mutate(percent = Freq / nresponses * 100) %>%
  arrange(-Freq) %>%
  filter(Freq != 0)



return_n <- sum(usageDF[which(usageDF$UserType == "Returning User"), "Freq"])
potential_n <- sum(usageDF[which(usageDF$UserType == "Potential User"), "Freq"])

usageDF$group_percent <- NA

usageDF[which(usageDF$UserType == "Returning User"), "group_percent"] <- usageDF[which(usageDF$UserType == "Returning User"), "Freq"] / return_n * 100

usageDF[which(usageDF$UserType == "Potential User"), "group_percent"] <- usageDF[which(usageDF$UserType == "Potential User"), "Freq"] / potential_n * 100

usageDF
```

</details>

---

> 44% (n=22) were returning user responses

<details><summary> Code supporting the above statement </summary>

```{r}
colSums(usageDF[which(usageDF$UserType == "Returning User"), c("Freq", "percent")])
```

</details>

---

> 56% (n=28) were potential users

<details><summary> Code supporting the above statement </summary>

```{r}
colSums(usageDF[which(usageDF$UserType == "Potential User"), c("Freq", "percent")])
```

</details>

---

> The majority of returning user responses (73%, n=16) belonged to the group who use the AnVIL for ongoing projects.  

<details><summary> Code supporting the above statement </summary>

```{r}
usageDF %>%
  filter(UserType == "Returning User") %>%
  head(1) %>%
  select(CurrentUsageDescription, Freq, group_percent)
```

</details>

---

> The majority of potential users were evenly split between two groups (46%, n=13 each), those who have never used the AnVIL (but have heard of it) and those who have used the AnVIL previously, but don't currently.

<details><summary> Code supporting the above statement </summary>

```{r}
usageDF %>%
  filter(UserType == "Potential User") %>%
  head(2) %>%
  select(CurrentUsageDescription, Freq, group_percent)
```

</details>

---

#### Figure 2B - Degree

<details><summary> Making a table for this data/question on degrees of respondents </summary>

```{r}
degreeDF <- resultsTidy$FurtherSimplifiedDegrees %>%
  table() %>%
  as.data.frame() %>%
  mutate(percent = Freq / nresponses * 100) %>%
  arrange(-Freq)

degreeDF
```

</details>

---

> Most respondents had obtained or were in the process of obtaining a PhD (62%, n=31)

<details><summary> Code supporting the above statement </summary>

```{r}
degreeDF %>%
  filter(str_detect(., "^PhD"))
```

</details>

---

> Clinical advanced degrees (MDs) (6%, n=3)

<details><summary> Code supporting the above statement </summary>

```{r}
degreeDF %>%
  filter(str_detect(., "MD"))
```

</details>

---

> Master's degrees (18%, n=9)

<details><summary> Code supporting the above statement </summary>

```{r}
degreeDF %>%
  filter(str_detect(., "Master"))
```

</details>

---

#### Figure 2C - Institution

<details><summary> Making a table for this data/question on institutional affiliation </summary>

```{r}
instDF <- resultsTidy %>%
  select(c(UserType, FurtherSimplifiedInstitutionalType)) %>%
  table() %>%
  as.data.frame() %>%
  mutate(percent = Freq / nresponses * 100) %>%
  arrange(-Freq)

instDF
```

</details>

---

> Most of the respondents using the AnVIL (n=21) reported being affiliated with a research intensive institution

<details><summary> Code supporting the above statement </summary>

```{r}
instDF %>%
  filter(UserType == "Returning User") %>%
  head(1) %>%
  select(FurtherSimplifiedInstitutionalType, Freq)
```

</details>

---

> one [using the AnVIL] reported being affiliated with an education focused institution

<details><summary> Code supporting the above statement </summary>

```{r}
instDF %>%
  filter(UserType == "Returning User") %>%
  filter(str_detect(FurtherSimplifiedInstitutionalType, "Education")) %>%
  select(FurtherSimplifiedInstitutionalType, Freq)
```

</details>

---

> Only potential users of the platform reported being affiliated with an industry-based institution

<details><summary> Code supporting the above statement </summary>

```{r}
instDF %>%
  filter(str_detect(FurtherSimplifiedInstitutionalType, "Industry")) %>%
  select(UserType, FurtherSimplifiedInstitutionalType, Freq)
```

</details>

---

#### Consortia

<details><summary> Making a table for this data/question on consortia affiliations </summary>

```{r}
consortiaDF <- resultsTidy %>%
  mutate(ConsortiaAffiliations = str_replace_all(ConsortiaAffiliations, c(";|&| and"), ",")) %>%
  separate_longer_delim(ConsortiaAffiliations,
           delim=", ") %>%
  mutate(ConsortiaAffiliations = 
           recode(ConsortiaAffiliations,
            "member tech dev group" = "AnVIL",
            "AnVIL Clinical Resource" = "AnVIL",
            "AnVIL " = "AnVIL"
           )
         ) %>%
  group_by(ConsortiaAffiliations, UserType) %>%
  summarize(count = n()) %>%
  drop_na() %>%
  arrange(-count)
```

</details>

---

> Of the 50 responses, 21 provided consortia affiliations

<details><summary>Code supporting the above statement</summary>

```{r}
sum(!is.na(resultsTidy$ConsortiaAffiliations))
```

</details>

---

> across 23 unique affiliations

<details><summary>Code supporting the above statement</summary>

```{r}
n_groups(consortiaDF)
```

</details>

---

> Of the 21 responses providing consortia affiliations, 13 were from returning users

<details><summary>Code supporting the above statement</summary>

```{r}
sum(resultsTidy[which(!is.na(resultsTidy$ConsortiaAffiliations)),"UserType"] == "Returning User")
```

</details>

---

> GREGoR, PRIMED, eMERGE, CCDG, GTEx were the top 5 most represented with n=3 each for GREGoR, PRIMED, and eMERGE and n=2 each for CCDG and GTEx.

<details><summary> Code supporting the above statement </summary>

```{r}
consortiaDF %>%
  summarize(sum_count = sum(count)) %>%
  arrange(-sum_count) %>%
  filter(ConsortiaAffiliations != "AnVIL") %>%
  head(n=5)
```

</details>

---

> all 5 of these consortia were represented in the subset of consortia affiliations reported by returning users

<details><summary> Code supporting the above statement </summary>

```{r}
consortiaDF %>%
  filter(UserType == "Returning User") %>%
  filter(str_detect(ConsortiaAffiliations, "GREGoR|PRIMED|eMERGE|CCDG|GTEx")) %>%
  summarize(present = count > 0)
```

</details>

---

#### Figure 3A - Research Experience

> 21 respondents report that they are extremely experienced in analyzing human genomic data

<details><summary> Code supporting the above statement </summary>

```{r}
table(resultsTidy$HumanGenomicExperience)["Extremely experienced"]
```

</details>

---

> only 6 respondents report that they are not at all experienced in analyzing human genomic data

<details><summary>Code supporting the above statement</summary>

```{r}
table(resultsTidy$HumanGenomicExperience)["Not at all experienced"]
```

</details>

---

> However, for human clinical data and non-human genomic data, more respondents report being not at all experienced in analyzing those data than report being extremely experienced

<details><summary> Code supporting the above statement </summary>

```{r}
sum(resultsTidy$NonHumanGenomicExperience == "Not at all experienced") > sum(resultsTidy$NonHumanGenomicExperience == "Extremely experienced")
```

```{r}
sum(resultsTidy$HumanClinicalExperience == "Not at all experienced") > sum(resultsTidy$HumanClinicalExperience == "Extremely experienced")
```

</details>

---

#### Figure 3A - Research Experience Overlap

> When limiting the responses we consider to include only respondents who reported being “moderately” or “extremely” experienced for at least one of the categories, we are left with 37 responses (17 from returning users)

<details><summary> Code supporting the above statement </summary>

```{r}
top_two_box <- resultsTidy %>%
  filter(humanGenomicFlag | clinicalFlag | nonHumanGenomicFlag) %>%
  select(UserType) %>%
  table()
```

```{r}
top_two_box_n <- sum(top_two_box)
top_two_box_n
```

```{r}
top_two_box["Returning User"]
```

</details>

---

> 32% (n=12) reported these levels of experience for all 3 research categories

<details><summary> Code supporting the above statement </summary>

Count (n = ):

```{r}
resultsTidy %>%
  filter(humanGenomicFlag == TRUE & clinicalFlag == TRUE & nonHumanGenomicFlag == TRUE) %>%
  nrow()
```

Percent: 

```{r}
resultsTidy %>%
  filter(humanGenomicFlag == TRUE & clinicalFlag == TRUE & nonHumanGenomicFlag == TRUE) %>%
  nrow() / top_two_box_n * 100
```

</details>

---

> 27% (n=10) reported this level of experience for only human genomic research (but no other research categories) 

<details><summary> Code supporting the above statement </summary>

Count (n = )

```{r}
resultsTidy %>%
  filter(humanGenomicFlag == TRUE & clinicalFlag == FALSE & nonHumanGenomicFlag == FALSE) %>%
  nrow()
```

Percent: 

```{r}
resultsTidy %>%
  filter(humanGenomicFlag == TRUE & clinicalFlag == FALSE & nonHumanGenomicFlag == FALSE) %>%
  nrow() / top_two_box_n * 100
```

</details>

---

> 16% (n=6) reported this level of experience for both human clinical and human genomic research (but not non-human genomic research)

<details><summary>Code supporting the above statement</summary>

Count (n = )

```{r}
resultsTidy %>%
  filter(humanGenomicFlag == TRUE & clinicalFlag == TRUE & nonHumanGenomicFlag == FALSE) %>%
  nrow()
```

Percent: 

```{r}
resultsTidy %>%
  filter(humanGenomicFlag == TRUE & clinicalFlag == TRUE & nonHumanGenomicFlag == FALSE) %>%
  nrow() / top_two_box_n * 100
```

</details>

---

> another 16% (n=6) reported this level of experience in analyzing both non-human and human genomic research

<details><summary> Code supporting the above statement</summary>

Count (n =):

```{r}
resultsTidy %>%
  filter(humanGenomicFlag == TRUE & clinicalFlag == FALSE & nonHumanGenomicFlag == TRUE) %>%
  nrow()
```

Percent: 

```{r}
resultsTidy %>%
  filter(humanGenomicFlag == TRUE & clinicalFlag == FALSE & nonHumanGenomicFlag == TRUE) %>%
  nrow() / top_two_box_n * 100
```

</details>

---

#### Figure 4 - Kind of Work

<details><summary> Making a table for this data/question on kind of work selections </summary>

```{r}
kindOfWorkDF <-
  resultsTidy %>%
  select(Timestamp, KindOfWork) %>%
  separate_longer_delim(KindOfWork, delim = ", ") %>%
  mutate(
    KindOfWork = recode(KindOfWork, "Program administration," = "Program administration", "computational education" = "Computational education"),
    value = TRUE
  ) %>%
  pivot_wider(names_from = KindOfWork, values_from = value, values_fill = FALSE)
```

</details>

---

> 44% (n=22) selected only 1 description, 36% (n=18) selected 2 descriptions, 16% (n=8) selected 3 descriptions, and 4% (n=2) selected 5 descriptions.

<details><summary> Code supporting the above statement </summary>

```{r}
numSelected <- kindOfWorkDF %>%
  select(!Timestamp) %>%
  rowSums()

numSelectedDF <- tibble("num_descriptions_selected" = numSelected) %>%
  count(num_descriptions_selected) %>%
  mutate(percentage_responses = round(n / nresponses * 100, 0))

numSelectedDF
```

</details>

---

> “Computational work” was the most frequently selected response, reported by 68% of respondents (n=34)

<details><summary> Code supporting the above statement </summary>

```{r}
numResponsesPerDescription <- data.frame("n" = colSums(kindOfWorkDF[, 2:ncol(kindOfWorkDF)])) %>%
  rownames_to_column("work_description") %>%
  mutate(percentage_responses = round(n / nresponses * 100, 0)) %>%
  arrange(-n)

numResponsesPerDescription %>% head(1)
```

</details>

---

> “Project management” at 36% (n=18) 

<details><summary> Code supporting the above statement </summary>

```{r}
numResponsesPerDescription %>% filter(str_detect(work_description, "management"))
```

</details>

---

> “Project leadership” at 24% (n=12) respectively.

<details><summary> Code supporting the above statement </summary>

```{r}
numResponsesPerDescription %>% filter(str_detect(work_description, "leadership"))
```

</details>

---

> Of the 22 respondents who selected only 1 description, 

<details><summary> Code supporting the above statement </summary>

```{r}
singleResponseRows <- which(rowSums(kindOfWorkDF[2:ncol(kindOfWorkDF)]) == 1) # these rows are responses where they only provided one description

singleResponseDF <- tibble("description" = unlist(lapply(1:length(singleResponseRows), function(x) colnames(kindOfWorkDF)[which(kindOfWorkDF[singleResponseRows[x], ] == TRUE)]))) %>% # for those rows, find the corresponding columns that are true and add the column names to a vector
  count(description) %>% # count the number of times each of those descriptions is there 
  mutate(percentage_singleResponses = n / sum(n) * 100) %>%
  arrange(-n) # arrange in descending order
  
singleResponseDF %>% 
  select(n) %>% 
  sum()  
```

</details>

---

> “Computational work” was the most frequently selected (n=13, 59%) [of only 1 description]

<details><summary> Code supporting the above statement </summary>

```{r}
singleResponseDF %>% head(1)
```

</details>

---

> Of the responses who selected more than one description, “Computational work” was paired most frequently with “Project management” or “Project leadership”. (n=11 and 7 respectively)

<details><summary> Code supporting the above statement </summary>

```{r}
find_pairs <- function(inputDF, rowOI) {
  pairs <- c()
  notNA_cols_combos <- t(combn(which(inputDF[rowOI, ] == TRUE), 2)) # rows will be indices for each pair
  for (rowIndex in 1:nrow(notNA_cols_combos)) {
    pairs <- c(pairs, paste0(unlist(colnames(inputDF)[notNA_cols_combos[rowIndex, ]]), collapse = "-"))
  }
  return(pairs)
}
```

```{r}
kindOfWorkDF_subset <- kindOfWorkDF[which(rowSums(kindOfWorkDF[, 2:ncol(kindOfWorkDF)]) > 1), -c(1)]

pairs_all <- unlist(lapply(
  1:nrow(kindOfWorkDF_subset),
  function(x) find_pairs(kindOfWorkDF_subset, x)
)) %>%
  as.data.frame() %>%
  `colnames<-`(c("pairs")) %>%
  group_by(pairs) %>%
  mutate(count = n()) %>%
  ungroup() %>%
  distinct() %>%
  arrange(-count)

print(pairs_all, n = nrow(pairs_all))
```

</details>

---

#### Figure 4 - Personas 

<details><summary> Making a table for this data/question on personas of respondents </summary>

```{r}
personaDF <- resultsTidy %>%
  select(c(persona, UserType)) %>%
  table() %>% 
  as.data.frame() %>% 
  arrange(-Freq)

personaDF
```

</details>

---

> 10 respondents were left uncategorized

<details><summary> Code supporting the above statement </summary>

```{r}
personaDF %>%
  filter(persona == "None assigned") %>%
  select(Freq) %>%
  sum()
```

</details>

---

> majority of respondents were assigned to either the Leadership (PI) persona (n=13, showing evidence of computational work together with some form of project management, leadership, or administration) or the Analyst persona (n=13, only reporting computational work)

<details><summary> Code supporting the above statement </summary>

```{r}
personaDF %>%
  group_by(persona) %>%
  summarize(sum = sum(Freq)) %>%
  arrange(-sum) %>%
  head(2)
```

</details>

---

> 7 respondents were categorized as an Admin persona

<details><summary> Code supporting the above statement </summary>

```{r}
personaDF %>%
  filter(persona == "Admin") %>%
  select(Freq) %>%
  sum()
```

</details>

---

> 2 potential users were assigned a Clinician persona because of selecting clinical work (this option was not selected by returning users)

<details><summary> Code supporting the above statement </summary>

```{r}
personaDF %>%
  filter(persona == "Clinician")
```

</details>

---

> 4 potential users were assigned an Educator persona while only 1 returning user was

<details><summary> Code supporting the above statement </summary>

```{r}
personaDF %>%
  filter(persona == "Educator")
```

</details>

---

### Barriers & user preferences

Statements made throughout the "Barriers & user preferences" Results section have code supporting them here.

#### Important Features by Persona

<details><summary> Code to make a plot for the observations in this section </summary>

```{r}
totalRanksdfPersona <-
  bind_rows(
    #Clinician
    resultsTidy %>%
      filter(persona == "Clinician") %>%
      select(contains("Rank")) %>%
      colSums(na.rm = TRUE) %>%
      as.data.frame() %>% `colnames<-`(c("totalRank")) %>%
      mutate(nranks = sum(resultsTidy$persona == "Clinician"),
             persona = "Clinician"),
    #Analyst
    resultsTidy %>%
      filter(persona == "Analyst") %>%
      select(contains("Rank")) %>%
      colSums(na.rm = TRUE) %>%
      as.data.frame() %>% `colnames<-`(c("totalRank")) %>%
      mutate(nranks = sum(resultsTidy$persona == "Analyst"),
            persona = "Analyst"),
    # Educator
    resultsTidy %>%
      filter(persona == "Educator") %>%
      select(contains("Rank")) %>%
      colSums(na.rm = TRUE) %>%
      as.data.frame() %>% `colnames<-`(c("totalRank")) %>%
      mutate(nranks = sum(resultsTidy$persona == "Educator"),
            persona = "Educator"),
    #PI
    resultsTidy %>%
      filter(persona == "PI") %>%
      select(contains("Rank")) %>%
      colSums(na.rm = TRUE) %>%
      as.data.frame() %>% `colnames<-`(c("totalRank")) %>%
      mutate(nranks = sum(resultsTidy$persona == "PI"),
             persona = "PI"),
    #Admin
    resultsTidy %>%
      filter(persona == "Admin") %>%
      select(contains("Rank")) %>%
      colSums(na.rm = TRUE) %>%
      as.data.frame() %>% `colnames<-`(c("totalRank")) %>%
      mutate(nranks = sum(resultsTidy$persona == "Admin"),
             persona = "Admin"),
    #None assigned
    resultsTidy %>%
      filter(persona == "None assigned") %>%
      select(contains("Rank")) %>%
      colSums(na.rm = TRUE) %>%
      as.data.frame() %>% `colnames<-`(c("totalRank")) %>%
      mutate(nranks = sum(resultsTidy$persona == "None assigned"),
              persona = "None Assigned")
  ) %>%
  mutate(UsertypeFeature = rownames(.)) %>%
  separate(UsertypeFeature, c("Usertype", "FeatureExtra"), sep = "Rank", remove = TRUE) %>%
  separate(FeatureExtra, c("Feature", "extra"), sep = "\\.", remove = TRUE) %>%
  mutate(Feature =
    case_when(Feature == "EasyBillingSetup" ~ "Easy billing setup",
              Feature == "FlatRateBilling" ~ "Flat-rate billing rather than use-based",
              Feature == "FreeVersion" ~ "Free version with limited compute or storage",
              Feature == "SupportDocs" ~ "On demand support and documentation",
              Feature == "ToolsData" ~ "Specific tools or datasets are available/supported",
              Feature == "CommunityAdoption" ~ "Greater adoption of the AnVIL by the scientific community")
  ) %>%
  group_by(persona, Feature, nranks) %>%
  summarize(totalRankAcrossUsertype = sum(totalRank)) %>%
  mutate(avgRank = totalRankAcrossUsertype / nranks)

totalRanksdfPersona %>% arrange(avgRank)
```

</details>

```{r}
gpdumbbell <- ggplot(totalRanksdfPersona,
aes(x = avgRank,
y = reorder(Feature, -avgRank))) +
geom_line() +
geom_point(aes(color = persona), size = 3.5) +
ggtitle("Rank the following features\n according to their importance\nto you by persona.")
gpdumbbell %<>% stylize_dumbbell(xmax=6, importance = TRUE, usertype = FALSE) +
  theme(text = element_text(size=12))
```

All 3 of the observations below are made from the plot above and by looking at the total ranks data frame (`totalRanksdfPersona`)

---

> When looking at responses specific to the assigned personas,  we observe that the average rank choice for easy billing setup is highest for Admins compared to other personas

---

> Educators and Clinicians rank both a free version with limited compute or storage and greater adoption by the scientific community more highly than other personas

---

> PIs rank having specific tools or datasets available/supported as their most important feature of AnVIL

---



#### Awareness - Figure 6

> Potential users were split at 46% (n=13) knowing about monthly AnVIL Demos or the support forum 

<details><summary> Code supporting the above statement </summary>

Counts observed in the plot (6B, 6D)

Awareness Percentage:

```{r}
resultsTidy %>% 
  filter(UserType == "Potential User") %>%
  filter(forumAwareness == "Aware of") %>% 
  nrow() / potential_n * 100
```

</details>

---

> and 54% (n=15) not being aware of the support opportunities

<details><summary> Code supporting the above statement </summary>

Counts observed in the plot (6B, 6D)

Not aware of Percentage:

```{r}
resultsTidy %>% 
  filter(UserType == "Potential User") %>%
  filter(forumAwareness == "Not Aware of") %>% 
  nrow() / potential_n * 100
```

</details>

---

If we look at this by defining a column of aware of either, these numbers don't match, suggesting that there are not always matching aware/not aware answers for both support options

<details><summary> Code supporting the above statement </summary>

```{r}
resultsTidy %>% 
  select(c(UserType, forumAwareness, AnVILDemoAwareness)) %>%
  mutate(supportAwareness = forumAwareness == "Aware of" | AnVILDemoAwareness == "Aware of") %>%
  group_by(UserType) %>%
  summarize(sumAware = sum(supportAwareness))
```

</details>

---

> only 71% (n=20) of potential users had matching aware/not aware responses for both AnVIL Demos and the support forum

<details><summary> Code supporting the above statement </summary>

Count (n = ):

```{r}
potential_matching <- resultsTidy %>%
  filter(UserType == "Potential User") %>%
  mutate(matching = forumAwareness == AnVILDemoAwareness) %>%
  select(matching) %>%
  sum()

potential_matching
```

Percentage: 

```{r}
potential_matching / potential_n * 100
```

</details>

---

> Of the 15 not aware respondents, only 73% (n=11) were not aware of both AnVIL Demos and the support forum

<details><summary> Code supporting the above statement </summary>

Count (n = )

```{r}
potential_na_matching <- resultsTidy %>%
  filter(UserType == "Potential User") %>%
  filter(forumAwareness == "Not Aware of" | AnVILDemoAwareness == "Not Aware of") %>%
  mutate(matching = forumAwareness == AnVILDemoAwareness) %>%
  select(matching) %>%
  sum()

potential_na_matching
```

Percentage: 

```{r}
potential_na_matching / 15 * 100
```

</details>

---

> Similarly, 86% (n=19) of returning users had matching aware/not aware responses for both AnVIL Demos and the support forum

<details><summary> Code supporting the above statement </summary>

Count (n = )

```{r}
returning_matching <- resultsTidy %>%
  filter(UserType == "Returning User") %>%
  mutate(matching = forumAwareness == AnVILDemoAwareness) %>%
  select(matching) %>%
  sum()

returning_matching
```

Percentage:

```{r}
returning_matching / return_n * 100
```

</details>

---

> Only 4 returning user responses were not aware of both the AnVIL Demos or the support forum

<details><summary> Code supporting the above statement </summary>

```{r}
returning_na_matching <- resultsTidy %>%
  filter(UserType == "Returning User") %>%
  filter(forumAwareness == "Not Aware of" | AnVILDemoAwareness == "Not Aware of") %>%
  mutate(matching = forumAwareness == AnVILDemoAwareness) %>%
  select(matching) %>%
  sum()

returning_na_matching
```

</details>

---

> Returning users showed a higher percentage of respondents who were aware of the support opportunities (n=16, 73% and n=17, 77%)

<details><summary> Code supporting the above statement </summary>

Counts observed in the plot (6B, 6D)

Demo Percentage:

```{r}
resultsTidy %>% 
  filter(UserType == "Returning User") %>%
  filter(AnVILDemoAwareness == "Aware of") %>% 
  nrow() / return_n * 100
```

Forum Percentage:

```{r}
resultsTidy %>% 
  filter(UserType == "Returning User") %>%
  filter(forumAwareness == "Aware of") %>% 
  nrow() / return_n * 100
```

</details>

---

> Returning users are also more represented in the group of respondents who have attended AnVIL Demos (n=12 or 71% of attenders)

<details><summary> Code supporting the above statement </summary>

Count (n = ):

```{r}
resultsTidy %>%
  filter(UserType == "Returning User") %>%
  filter(str_detect(AnVILDemo, "Yes")) %>%
  nrow()
```

Percentage:

```{r}
resultsTidy %>%
  filter(UserType == "Returning User") %>%
  filter(str_detect(AnVILDemo, "Yes")) %>%
  nrow() / 
resultsTidy %>%
  filter(str_detect(AnVILDemo, "Yes")) %>%
  nrow() * 100
```

</details>

---

> [Returning users] utilized the support forum (n=8 or 67% of those who have read through, posted, or replied in this sample)

<details><summary> Code supporting the above statement </summary>

Count (n = ):

```{r}
resultsTidy %>%
  filter(UserType == "Returning User") %>%
  filter(str_detect(AnVILSupportForum, "Answered|Posted|Read")) %>%
  nrow()
```

Percentage:

```{r}
resultsTidy %>%
  filter(UserType == "Returning User") %>%
  filter(str_detect(AnVILSupportForum, "Answered|Posted|Read")) %>%
  nrow() /
  resultsTidy %>%
  filter(str_detect(AnVILSupportForum, "Answered|Posted|Read")) %>%
  nrow() * 100
```

</details>

---

> most poll respondents have not attended AnVIL Demos with only 34% (n=17) reporting attendance

<details><summary> Code supporting the above statement </summary>

Count (n = ):

```{r}
resultsTidy %>%
  filter(str_detect(AnVILDemo, "Yes")) %>%
  nrow()
```

Percentage:

```{r}
resultsTidy %>%
  filter(str_detect(AnVILDemo, "Yes")) %>%
  nrow() / nresponses * 100
```

</details>

---

> Most respondents have not utilized the support forum with only 24% (n=12) in some way reporting use

<details><summary> Code supporting the above statement </summary>

Count (n = ):

```{r}
resultsTidy %>%
  filter(str_detect(AnVILSupportForum, "Answered|Posted|Read")) %>%
  nrow()
```

Percentage:

```{r}
resultsTidy %>%
  filter(str_detect(AnVILSupportForum, "Answered|Posted|Read")) %>%
  nrow() / nresponses * 100
```

</details>

---

### User technological comfort

Statements made throughout the "User technological comfort" Results section have code supporting them here.

#### Where analyses are run 

<details><summary> Making a table for this data/question on where respondents run analyses </summary>

```{r}
runLocDF <- resultsTidy %>%
  separate_longer_delim(WhereAnalysesRun, ", ") %>%
  mutate(WhereAnalysesRun =
           recode(WhereAnalysesRun,
                  "Amazon Web Services (AWS)" = "AWS",
                  "Galaxy (usegalaxy.org)" = "Galaxy",
                  "Galaxy Australia" = "Galaxy",
                  "Google Cloud Platform (GCP)" = "GCP",
                  "Institutional High Performance Computing cluster (HPC)" = "Institutional HPC",
                  "Personal computer (locally)," = "Personal computer (locally)",
                  "local server" = "Institutional HPC")
         ) %>%
  select(c(UserType, WhereAnalysesRun)) %>%
  table() %>%
  as.data.frame() %>%
  mutate(percent = Freq / nresponses * 100) %>%
  arrange(-Freq)

runLocDF$group_percent <- NA
runLocDF[which(runLocDF$UserType == "Returning User"), "group_percent"] <- runLocDF[which(runLocDF$UserType == "Returning User"), "Freq"] / return_n * 100

runLocDF[which(runLocDF$UserType == "Potential User"), "group_percent"] <- runLocDF[which(runLocDF$UserType == "Potential User"), "Freq"] / potential_n * 100

runLocDF
```

</details>

---

> Institutional High Performance Computers (HPCs) 70%, n=35

<details><summary> Code supporting the above statement </summary>

```{r}
colSums(runLocDF[which(str_detect(runLocDF$WhereAnalysesRun, "HPC")), c("Freq", "percent")])
```

</details>

---

> 64% of returning users

<details><summary> Code supporting the above statement </summary>

```{r}
runLocDF %>%
  filter(UserType == "Returning User") %>%
  filter(str_detect(WhereAnalysesRun, "HPC")) %>%
  select(group_percent)
```

</details>

---

> 75% of potential users

<details><summary> Code supporting the above statement </summary>

```{r}
runLocDF %>%
  filter(UserType == "Potential User") %>%
  filter(str_detect(WhereAnalysesRun, "HPC")) %>%
  select(group_percent)
```

</details>

---

> locally on personal computers (68%, n=34) 

<details><summary> Code supporting the above statement </summary>

```{r}
colSums(runLocDF[which(str_detect(runLocDF$WhereAnalysesRun, "locally")), c("Freq", "percent")])
```

</details>

---

> 55% of returning users 

<details><summary> Code supporting the above statement </summary>

```{r}
runLocDF %>%
  filter(UserType == "Returning User") %>%
  filter(str_detect(WhereAnalysesRun, "locally")) %>%
  select(group_percent)
```

</details>

---

> 79% of potential users

<details><summary> Code supporting the above statement </summary>

```{r}
runLocDF[which(str_detect(runLocDF$WhereAnalysesRun, "locally") & runLocDF$UserType == "Potential User"), "Freq"] / potential_n * 100
```

</details>

---

> For provided cloud options, GCP was reported as used the most (n=21) split across user types

<details><summary> Code supporting the above statement </summary>

```{r}
runLocDF %>%
  filter(str_detect(WhereAnalysesRun, "Azure|GCP|AWS")) %>%
  group_by(WhereAnalysesRun) %>%
  summarize(across(c(Freq, percent), sum, .names = "sum_{.col}")) %>%
  arrange(-sum_Freq)
```

</details>

---

> (55% of returning users)

<details><summary> Code supporting the above statement </summary>

```{r}
runLocDF %>%
  filter(UserType == "Returning User") %>%
  filter(str_detect(WhereAnalysesRun, "GCP")) %>%
  select(group_percent)
```

</details>

---

>  (and 32% of potential users)

<details><summary> Code supporting the above statement </summary>

```{r}
runLocDF %>%
  filter(UserType == "Potential User") %>%
  filter(str_detect(WhereAnalysesRun, "GCP")) %>%
  select(group_percent)
```

</details>

---

> We also observed that potential users report using Galaxy (a free option)(18%, n=5), more than returning users do (5%, n=1)

<details><summary> Code supporting the above statement </summary>

```{r}
runLocDF[which(str_detect(runLocDF$WhereAnalysesRun, "Galaxy")),c("WhereAnalysesRun", "Freq", "group_percent")]
```

</details>

---

> Potential users also submitted All of Us, sciserver.org, and UKBB RAP as other platforms

<details><summary> Code supporting the above statement </summary>

```{r}
runLocDF %>%
  filter(str_detect(WhereAnalysesRun, "Us|sciserver|RAP"))
```

</details>

---

### User resource and data needs

Statements made throughout the "User resource and data needs" Results section have code supporting them here.

#### Foreseeable computational needs

<details><summary> Making a table for this data/question on requested computational/storage resources </summary> 

```{r}
computationalNeedOverlap <- 
  list(storageList =
       which(str_detect(resultsTidy$NeededResources, "storage")),
     nodesList =
       which(str_detect(resultsTidy$NeededResources, "nodes")),
     gpuList =
       which(str_detect(resultsTidy$NeededResources, "GPUs")),
     memoryList =
       which(str_detect(resultsTidy$NeededResources, "memory")))


overlap_table <- process_region_data(Venn(computationalNeedOverlap))
overlap_table
```

</details>

---

> The most common response was needing large amounts of storage (e.g., Terabytes), selected by 50% (n=11)

<details><summary> Code supporting the above statement </summary>

```{r}
length(computationalNeedOverlap$storageList)
```

```{r}
length(computationalNeedOverlap$storageList) / return_n * 100
```

</details>

---

> 32% (n=7) only selected this option [of large storage]

<details><summary> Code supporting the above statement </summary>

```{r}
overlap_table %>%
  filter(name == "storageList")
```

```{r}
overlap_table %>%
  filter(name == "storageList") %>%
  select(count) / return_n * 100
```

</details>

---

> Many nodes 27%

<details><summary> Code supporting the above statement </summary>

```{r}
length(computationalNeedOverlap$nodesList) / return_n * 100
```

</details>

---

> GPUs 27%

<details><summary> Code supporting the above statement </summary>

```{r}
length(computationalNeedOverlap$gpuList) / return_n * 100
```

</details>

---

> large memory 18%

<details><summary> Code supporting the above statement </summary>

```{r}
length(computationalNeedOverlap$memoryList) / return_n * 100
```

</details>

---

> Only 1 response selected all 4 computational need

<details><summary> Code supporting the above statement </summary>

```{r}
overlap_table %>%
  filter(id == "1/2/3/4")
```

</details>

---

> The most common combination of selections was GPUs and many nodes (n=2)

<details><summary> Code supporting the above statement </summary>

```{r}
overlap_table %>%
  filter(str_detect(id, "/")) %>%
  arrange(-count) %>%
  head(1)
```

</details>

---

> All other combinations were only selected once or not at all

<details><summary> Code supporting the above statement </summary>

```{r}
overlap_table %>%
  filter(str_detect(id, "/")) %>%
  filter(name != "nodesList/gpuList") %>%
  select(count) %>% 
  unique()
```

</details>

---

> 11 possible combinations of multiple options

<details><summary> Code supporting the above statement </summary>

```{r}
noptions <- resultsTidy %>% 
  separate_longer_delim(NeededResources, ", ") %>% 
  select(NeededResources) %>% 
  drop_na() %>% 
  filter(NeededResources != "I don't know") %>% 
  unique() %>% 
  nrow()

npossible <- 0
for (i in c(2:noptions)){
  npossible <- npossible + choose(noptions, i)
}

npossible
```

</details>

---

#### DMS repository

<details><summary> Making a table for this data/question on data sharing repositories for DMS Policy </summary>

```{r}
dmsDFwUT <- resultsTidy %>% 
  separate_longer_delim(RepositoriesDMS, ", ") %>% 
  separate_longer_delim(RepositoriesDMS, delim=" & ") %>%
  mutate(RepositoriesDMS =
           case_when(
             str_detect(RepositoriesDMS, regex("dbgap", ignore_case = TRUE)) ~ "dbGaP",
             .default = as.character(RepositoriesDMS)
                     )
         ) %>%
  select(c(UserType, RepositoriesDMS)) %>% 
  table() %>% 
  as.data.frame() %>% 
  mutate(percent = Freq / nresponses * 100) %>% 
  arrange(-Freq)

dmsDFwUT$group_percent <- NA
dmsDFwUT[which(dmsDFwUT$UserType == "Returning User"), "group_percent"] <- dmsDFwUT[which(dmsDFwUT$UserType == "Returning User"), "Freq"] / return_n * 100

dmsDFwUT[which(dmsDFwUT$UserType == "Potential User"), "group_percent"] <- dmsDFwUT[which(dmsDFwUT$UserType == "Potential User"), "Freq"] / potential_n * 100

dmsDFwUT
```

</details>

---

> 46% (n=23) of all respondents flagged the AnVIL as a repository that they use or are considering use of to share data to comply with the NIH DMS policy

<details><summary> Code supporting the above statement </summary>

```{r}
dmsDFwUT %>%
  filter(RepositoriesDMS == "AnVIL") %>%
  summarize(across(c(Freq, percent), sum, .names = "sum_{.col}"))
```
</details>

---

> Of those 23, 65% (n=15) were returning users of the AnVIL 

<details><summary> Code supporting the above statement </summary>

```{r}
returning_selectedAnVIL <- dmsDFwUT %>% 
  filter(RepositoriesDMS == "AnVIL") %>%
  filter(UserType == "Returning User") %>%
  select(Freq) %>% unlist() %>% unname()

returning_selectedAnVIL

returning_selectedAnVIL / sum(dmsDFwUT[which(dmsDFwUT$RepositoriesDMS == "AnVIL"), "Freq"]) * 100
```

</details>

---

> (68% of the returning user sample of this community poll)

<details><summary> Code supporting the above statement </summary>

```{r}
dmsDFwUT %>%
  filter(UserType == "Returning User") %>%
  filter(RepositoriesDMS == "AnVIL") %>%
  select(group_percent)
```

</details>

---

#### Controlled Access Data Sets

---

> Over half of all respondents (n=29) reported that they are “extremely interested” in working with controlled access datasets

<details><summary> Code supporting the above statement </summary>

```{r}
extremely_interested_respondents <- unname(table(resultsTidy$InterestControlledData)[5])

extremely_interested_respondents
```

```{r}
extremely_interested_respondents / nresponses * 100
```

</details>

---

<details><summary> Making a table for this data/question on specific interest in controlled access data </summary>

```{r}
controlledDataDF <- resultsTidy %>% 
  separate_longer_delim(AccessWhichControlledData, ", ") %>% 
  select(AccessWhichControlledData) %>% 
  table() %>% 
  as.data.frame() %>% 
  mutate(percent = Freq/ nresponses * 100) %>% 
  arrange(-Freq)

controlledDataDF
```

</details>

> All of Us and UK Biobank were the most selected (n=34 each)

<details><summary> Code supporting the above statement </summary>

```{r}
controlledDataDF %>%
  head(2)
```

</details>

> GTEx was selected by 64% (n=32)

<details><summary> Code supporting the above statement </summary>

```{r}
controlledDataDF %>%
  filter(str_detect(AccessWhichControlledData, "GTEx"))
```

</details>

---

> CCDG was selected by 40% (n=20)

<details><summary> Code supporting the above statement </summary>

```{r}
controlledDataDF %>%
  filter(str_detect(AccessWhichControlledData, "CCDG"))
```

</details>

---

#### Different types of data

<details><summary> Making a table for this data/question on experience with different types of data </summary>

```{r}
typeOfDataDF <- resultsTidy %>% 
    separate_longer_delim(TypesOfData, delim=", ") %>%
    mutate(TypesOfData =
               recode(TypesOfData,
                      "I don't analyze data on AnVIL" = NA_character_,
                      "I store data in AnVIL. I don’t analyze it." = NA_character_,
                      "Used in training for analysis of genomes (variant calling)" = "Variant Calling"
               )
    ) %>%
    select(TypesOfData) %>%
    drop_na(TypesOfData) %>% table() %>% 
  as.data.frame() %>%
  mutate(percent = Freq / nresponses * 100) %>%
  arrange(-Freq)

typeOfDataDF
```

</details>

---

> Genomes/exomes (88%, n=44)

<details><summary> Code supporting the above statement </summary>

```{r}
typeOfDataDF %>%
  filter(TypesOfData == "Genomes/exomes")
```

</details>

---

> Transcriptomes (62%, n=31)

<details><summary> Code supporting the above statement </summary>

```{r}
typeOfDataDF %>%
  filter(TypesOfData == "Transcriptomes")
```

</details>

---

> A variety of other options (e.g., Phenotypic, Single Cell, Electronic Health Record, Epigenomes, Metabolomes, Proteomes, Imaging, etc.) were selected at a rate of at least 10% (n=5), but no more than 40% (n=20)

<details><summary> Code supporting the above statement </summary>

```{r}
typeOfDataDF %>%
  filter(percent >= 10) %>%
  filter(percent <= 40)
```

</details>

---

> Survey, structural, and variant calling were the only options selected or mentioned by fewer than 10% of respondents

<details><summary> Code supporting the above statement </summary>

```{r}
typeOfDataDF %>%
  filter(percent < 10)
```

</details>

---




